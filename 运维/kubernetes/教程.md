# 下载

## 服务器安装配置

### 1. 安装centos7

[centos7 下载链接](https://mirrors.huaweicloud.com/centos-vault/7.9.2009/isos/x86_64/CentOS-7-x86_64-Everything-2009.iso)

### 2. 配置yum环境

1. 备份环境

```shell
cp -a /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak
```

2. 使用华为云镜像地址

```shell
wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.huaweicloud.com/repository/conf/CentOS-7-anon.repo
```

3. 清除原有缓存

```shell
yum clean all

```

4. 刷新缓存

```shell
yum makecache
```

### 3. 检查ssh环境是否安装

```shell
rpm -qa|grep -E "openssh"
```

> 出现以下输出代表则安装

* openssh-7.4p1-11.el7.x86_64
* openssh-server-7.4p1-11.el7.x86_64
* openssh-clients-7.4p1-11.el7.x86_64

> 否则安装

```shell
yum install openssh-server -y
```

1. 查看ssh配置

```shell
vim /etc/ssh/sshd_config
```

2. 开放防火墙

```shell
sudo firewall-cmd --zone=public --add-port=22/tcp --permanent  
sudo service firewalld restart  
```

3. 永久关闭防火墙

```shell
systemctl disable firewalld 
```

4. 公钥写入服务器

```shell
"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDHBh2mWGRseRdiyf9abEdyyL8TSP8qeri40NcA7jMXKhKeqPVbOJaScYZJa2MxK9Y5NamZUrpIxQqtZqHCOWohRxdfnxpj4F+OzGTDKCMU7P1vkvygJNYFhB/zcrGf+wH6yXq6PEbbgWx5a9ITVRvPRrZ6IVm6q4Ix+3uxzf71DkufRJ+6yjFn/PhD2YkhM5pH6KtS934H7bJfdDl+Tv/2QY3Xk2c2c/v34YWBHgMPtSjW4EFuF9FqFVcpyrIW+5X6i4gAYlSPNK6kEM4OCUoYcEhF7AvxHWQsxBhN7281QHvGhPJJCQtBSwyzin1zit8JO2ks1VRtXzSBGCSWbeaBoELCfbJ0xNCsrdEZjjB/kw98wSt+9jQs4v7wBYcAVUf891KBk88dtOq+7Ry1db8tj+vm/D2CWtVM9gpJnsJiyRyjBb5dPMtBDGF+nUlFIRTDxuClPNJkn7PjIVnE99o0G3g1YDdL+y2fRILGxWw7cw+YOl6CNVAwU8aiOq+FlJM= enigma@EnigmadeMac-Pro.local" >> /root/.ssh/authorized_keys
```

5. 重启ssh服务

```shell
systemctl restart sshd.service
```

6. 使用桥接模式固定网络
1. 编辑配置文件

```shell
vim /etc/sysconfig/network-scripts/ifcfg-ens33
```

```shell
# 更新
BOOTPROTO="none" 
# 编辑
NM_CONTROLLED="yes"
IPADDR="192.168.3.15"  # 这里就是你设置的固定IP
NETMASK="255.255.255.0" # 上图中IPv4 子网掩码
GATEWAY="192.168.3.1"   # 上图中IPv4 默认网关
DNS1="192.168.3.1"  

```

## 安装k8s

### 1. 安装前配置

1. 设置主机名

```shell
hostnamectl set-hostname <hostname>
```

2. 配置dns

```shell
cat >> /etc/hosts << EOF
192.168.3.15 k8s-master
192.168.3.16 k8s-node-1
192.168.3.17 k8s-node-2
EOF
```

3. 将桥接的IPv4流量传递到iptables的链

```shell
cat > /etc/sysctl.d/k8s.conf << EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
```

4. 使得配置生效

```shell
sysctl --system 
```

5. 时间同步

```shell
yum install ntpdate -y # 安装utpdate工具
ntpdate time.windows.com # 设置系统时间与网络时间同步
hwclock --systohc # 将系统时间写入硬件时间
timedatectl set-timezone Asia/Shanghai # 设置系统时区为上海
```

6. 禁用swap

```shell
swapoff -a  # 临时
sed -ri 's/.*swap.*/#&/' /etc/fstab    # 永久
```

## 2. 安装docker

1. 下载docker依赖工具

```shell
yum install -y yum-utils \
           device-mapper-persistent-data \
           lvm2 --skip-broken
```

2. 配置docker镜像源

```shell
wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.huaweicloud.com/docker-ce/linux/centos/docker-ce.repo
```

3. 替换软件仓库地址

```shell
sudo sed -i 's+download.docker.com+mirrors.huaweicloud.com/docker-ce+' /etc/yum.repos.d/docker-ce.repo
```

4. 更新索引文件

```shell
sudo yum makecache fast
```

5. 安装docker

```shell
sudo yum install -y docker-ce 
```

6. 添加开机自启动

```shell
systemctl enable docker
```

## 安装k8s

1. 配置安装源

```shell
cp /etc/yum.repos.d/kubernetes.repo /etc/yum.repos.d/kubernetes.repo.bak
```

2. 写入镜像源

```shell
cat > /etc/yum.repos.d/kubernetes.repo << EOF
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0

gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

```

1. 安装 kubeadm、kubelet、kubectl

```shell
yum install -y kubelet-1.23.6 kubeadm-1.23.6 kubectl-1.23.6

```

2. 配置开机自启动

```shell
systemctl enable kubelet
```

1. 启动master的k8s {#启动master的k8s}

```shell
kubeadm init \
      --apiserver-advertise-address=192.168.3.17 \
      --image-repository registry.aliyuncs.com/google_containers \
      --kubernetes-version v1.23.6 \
      --service-cidr=10.96.0.0/12 \
      --pod-network-cidr=10.244.0.0/16
```

2. 查看启动报错日志

```shell
journalctl -xefu kubelet
```

> 目前已知错误

1. 错误日志表明docker 驱动不可用

```log
Jan 19 01:09:46 k8s-master kubelet[4459]: E0119 01:09:46.180661    4459 server.go:302] "Failed to run kubelet" err="failed to run Kubelet: misconfiguration: kubelet cgroup driver: \"systemd\" is different from docker cgroup driver: \"cgroupfs\""
```

> 解决方案就是将驱动改掉 在 <code>/etc/docker/daemon.json</code> 中加入属性 **exec-opt**

```json
{
  ...
  "registry-mirrors": [
    "https://registry.cn-hangzhou.aliyuncs.com"
  ],
  "exec-opts": [
    "native.cgroupdriver=systemd"
  ]
  ...
}

```

3. 查看docker驱动
   docker info|grep Driver
4. 重置k8s

```shell
kubeadm reset
```

5. 启动成功

![启动成功截图](./img/k8s_start_success.png)

```shell
kubeadm join 192.168.3.15:6443 --token i96qyt.98nr3nw9u6bcyjb6 \
        --discovery-token-ca-cert-hash sha256:e7692c714af85261f62e27936ea51ad23666adb9a0616629d8f326603aead278 

kubeadm join 192.168.3.16:6443 --token lfnqoy.rrtcx5ohfgox0v2p \
        --discovery-token-ca-cert-hash sha256:9b3a2d1d37c13293266ddfbef4ac41d2027c38bd9ddf2dc52ff4d085dcdea1b8 
       
kubeadm join 192.168.3.17:6443 --token lzezel.pextlnbvqj1lk82c \
        --discovery-token-ca-cert-hash sha256:71a573c3959ad1fe8adeae4b8898c290f3d86f2973d144c43f8df05fe3da512c 
         
```

6. 随后执行启动成功建议

```shell
  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

```

6. token 过期创建token

```shell
kubeadm token create
```

7. 没有过期就查看token

```shell
kubeadm token list
```

8. 生成token-hash

```shell
openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'
```

9. 重置一下node节点

```shell
kubeadm reset 信息
```

6. 集群加入节点

```shell
kubeadm join 192.168.3.15:6443 --token i96qyt.98nr3nw9u6bcyjb6    --discovery-token-ca-cert-hash sha256:e7692c714af85261f62e27936ea51ad23666adb9a0616629d8f326603aead278
```

7. 配置网络
    1. 下载calico网络配置 [calico.yml](./file/calico.yml)
   ```shell
    curl https://docs.projectcalico.org/manifests/calico.yaml -O
    ```
    2. 修改网络配置 <code> CALICO_IPV4POOL_CIDR </code> [网络配置](#启动master的k8s) 与此处的 <code>
       pod-network-cidr </code>一致
    3. 下载文件所需镜像
   ```shell
   grep image calico.yaml 
   ```
    4. 如有需要可替换docker 下载地址切换为 阿里云私服 地址
       docker.io/calico -> registry.cn-hangzhou.aliyuncs.com/mhr
   5. 创建私钥
    ```shell
   kubectl create secret -n kube-system docker-registry my-aliyun  --docker-server=registry.cn-hangzhou.aliyuncs.com   --docker-username=马海荣   --docker-password=mmmm0827
    ```
    5. 上传到服务器
   ```shell
      scp -p calico.yaml root@192.168.3.15:/opt/k8s/calico.yaml
   ```
    6. 构建网络
   ```shell
   kubectl apply -f calico.yaml
   ```
    7. 查看网络信息
   ```shell
   kubectl get po -n kube-system
   ```
   8. 结果如下
      
   |                  NAME                  | READY |        STATUS         |  RESTARTS   |  AGE  |
   |:--------------------------------------:|:-----:|:---------------------:|:-----------:|:-----:|
   | calico-kube-controllers-744c7d9b-bbfxc |  1/1  |        Running        |      0      | 106s  |
   |           calico-node-6l977            |  0/1  |   Init:ErrImagePul    |      0      | 106s  |
   |           calico-node-76l87            |  0/1  | Init:ImagePullBackOff |      0      | 106s  |
   |           calico-node-zpsrk            |  1/1  |        Running        |      0      | 106s  |    
   |        coredns-6d8c4cb4d-brxjx         |  1/1  |        Running        |      0      | 2d21h |   
   |        coredns-6d8c4cb4d-pchnj         |  1/1  |        Running        |      0      | 2d21h |  
   |            etcd-k8s-master             |  1/1  |        Running        | 2(2d6h ago) | 2d21h | 
   |       kube-apiserver-k8s-master        |  1/1  |        Running        | 2(2d6h ago) | 2d21h |
   |   kube-controller-manager-k8s-master   |  1/1  |        Running        | 2(2d6h ago) | 2d21h | 
   |            kube-proxy-jcgmm            |  1/1  |        Running        | 1(2d6h ago) | 2d21h |
   |            kube-proxy-jglwq            |  1/1  |        Running        |      0      | 2d6h  |
   |            kube-proxy-t2jqx            |  1/1  |        Running        |      0      | 2d6h  |
   |       kube-scheduler-k8s-master        |  1/1  |        Running        | 2(2d6h ago) | 2d21h |
   9. 节点出现问题排查命令
   ```shell
   kubectl  describe po calico-node-6l977 -n kube-system
   ```
   10. 测试k8s集群
      1. 创建nginx
      ```shell
      kubectl create deployment nginx --image=registry.cn-hangzhou.aliyuncs.com/mhr/nginx
      ```
      2. 暴露端口
      ```shell
      kubectl expose deployment nginx --port=80 --type=NodePort
      ```
      3. 查看信息
      ```shell
      kubectl get pod,svc
      ```

   11. 在任意节点使用kubectl
       1. 将 master 节点中 /etc/kubernetes/admin.conf 拷贝到需要运行的服务器的 /etc/kubernetes 目录中
       ```
        scp /etc/kubernetes/admin.conf root@k8s-node-1:/etc/kubernetes
      ```
       2. 在对应的服务器上配置环境变量
      ```shell
        echo "export KUBECONFIG=/etc/kubernetes/admin.conf" >> ~/.bash_profile
        source ~/.bash_profile
       ```   

### k8s 常用命令

1. 查看节点

```shell
kubectl get nodes/no
``` 

2. 查看组件状态

```shell
kubectl get componentstatus/cs
```

